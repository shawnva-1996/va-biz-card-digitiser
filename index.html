<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Contacts CRM (Firestore)</title>
  <style>
    :root{
      --brand:#1976d2; --brand-dark:#115293;
      --accent:#22c55e; --danger:#ef4444; --warning:#f59e0b;

      --bg-light:#ffffff; --text-light:#111; --muted-light:#667085; --card-light:#f9fafb; --border-light:#e5e7eb; --input-light:#f3f4f6;

      --bg-dark:#0f172a; --text-dark:#e5eefb; --muted-dark:#9aa4b2; --card-dark:#0b1221; --border-dark:#1c2741; --input-dark:#0b1426;
    }
    html,body{margin:0;height:100%;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    body.light{background:var(--bg-light);color:var(--text-light)}
    body.dark{background:linear-gradient(180deg,var(--card-dark),var(--bg-dark));color:var(--text-dark)}

    .hidden{display:none !important}

    /* ---------- LOGIN SCREEN ---------- */
    .login-wrap{
      min-height:100dvh; display:flex; align-items:center; justify-content:center; padding:24px;
    }
    .login-card{
      width:100%; max-width:420px; border:1px solid; border-radius:16px; padding:18px;
    }
    body.dark .login-card{background:var(--card-dark); border-color:var(--border-dark)}
    body.light .login-card{background:var(--card-light); border-color:var(--border-light)}
    .login-card h1{margin:0 0 8px 0; font-size:20px}
    .login-card p{margin:0 0 12px 0; opacity:.8}
    .login-row{display:flex; gap:8px; flex-wrap:wrap}
    .login-row input{flex:1 1 180px; min-height:46px; border-radius:12px; border:1px solid; padding:12px}
    body.dark .login-row input{background:var(--input-dark); border-color:#1e2a43; color:var(--text-dark)}
    body.light .login-row input{background:var(--input-light); border-color:var(--border-light); color:var(--text-light)}
    .btn{display:inline-flex; align-items:center; gap:.5rem; padding:12px 14px; border-radius:12px; border:1px solid transparent; background:var(--brand); color:#fff; font-weight:700; cursor:pointer; text-decoration:none; min-height:44px}
    .btn.secondary{background:transparent; border:1px solid}
    body.dark .btn.secondary{color:var(--text-dark); border-color:#22314f}
    body.light .btn.secondary{color:var(--text-light); border-color:var(--border-light); background:var(--input-light)}
    .btn.danger{background:var(--danger); color:#fff}

    /* ---------- APP SHELL ---------- */
    .app{max-width:980px;margin:0 auto;padding:12px 12px 96px}
    header{position:sticky;top:0;z-index:20;backdrop-filter:blur(8px);padding:8px;border-bottom:1px solid;display:block;overflow:visible}
    body.dark header{background:rgba(11,18,33,.85);border-color:#1e293b}
    body.light header{background:rgba(255,255,255,.9);border-color:var(--border-light)}
    .row{display:flex;gap:8px;align-items:center}
    .wrap{flex-wrap:wrap}
    .grow{flex:1}
    .toolbar{display:flex;gap:8px;align-items:center}
    .header-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .search{position:relative;flex:1 1 480px;min-width:260px}
    .search input{width:100%;padding:12px 12px 12px 42px;border-radius:12px;border:1px solid;min-height:44px;font-size:16px}
    .search .icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);opacity:.7}
    body.dark .search input{background:var(--input-dark);border-color:#1e2a43;color:var(--text-dark)}
    body.light .search input{background:var(--input-light);border-color:var(--border-light);color:var(--text-light)}
    #filtersBtn{flex:0 0 auto}
    #filters{display:none;position:relative;z-index:3;gap:8px;flex-wrap:wrap;margin-top:8px}
    #filters select{min-height:44px;padding:10px 12px;border-radius:999px;border:1px solid}
    body.dark #filters select{background:#0d1b33;border-color:#28406f;color:#cde2ff}
    body.light #filters select{background:#fff;border-color:var(--border-light);color:var(--text-light)}
    .counter{font-size:14px;opacity:.85}

    .list{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}
    @media(min-width:720px){.list{grid-template-columns:1fr 1fr}}
    .card{border:1px solid;border-radius:16px;padding:14px;display:flex;flex-direction:column;gap:8px}
    body.dark .card{background:var(--card-dark);border-color:var(--border-dark)}
    body.light .card{background:var(--card-light);border-color:var(--border-light)}
    .title{font-weight:800;font-size:16px}
    .subtitle{font-size:13px;opacity:.85}
    .inline{display:inline-flex;gap:6px;align-items:center;flex-wrap:wrap}
    .copy{border:none;background:transparent;cursor:pointer;font-size:16px;min-width:32px;min-height:32px;border-radius:8px}
    body.dark .copy:hover{background:#0f213f}
    body.light .copy:hover{background:#eaeefc}

    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .fab{position:fixed;right:16px;bottom:16px;z-index:10}

    .empty{opacity:.7;text-align:center;padding:24px}

    /* ---------- MODAL (spacious) ---------- */
    dialog{border:none;border-radius:18px;max-width:min(1000px,92vw);width:100%;padding:0;overflow:hidden}
    body.dark dialog{background:#0b1324;color:var(--text-dark)}
    body.light dialog{background:#fff;color:var(--text-light);border:1px solid var(--border-light)}
    .modal-head{position:sticky;top:0;z-index:2;display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid;background:inherit}
    body.dark .modal-head{border-color:#1e2b46}
    body.light .modal-head{border-color:var(--border-light)}
    .modal-body{padding:16px;max-height:70vh;overflow:auto}
    .modal-foot{position:sticky;bottom:0;z-index:2;display:flex;justify-content:space-between;gap:8px;padding:12px 16px;border-top:1px solid;background:inherit}
    body.dark .modal-foot{border-color:#1e2b46}
    body.light .modal-foot{border-color:var(--border-light)}
    .grid{display:grid;gap:12px}
    .grid.two{grid-template-columns:1fr}
    @media(min-width:900px){.grid.two{grid-template-columns:1fr 1fr}}
    label{font-size:12px;opacity:.8}
    input[type=text], textarea{width:100%;padding:12px;border-radius:12px;border:1px solid;min-height:44px}
    body.dark input[type=text], body.dark textarea{background:var(--input-dark);border-color:#1e2a43;color:var(--text-dark)}
    body.light input[type=text], body.light textarea{background:var(--input-light);border-color:var(--border-light);color:var(--text-light)}
  </style>
</head>
<body class="dark">

  <!-- LOGIN FIRST -->
  <div id="loginView" class="login-wrap">
    <div class="login-card">
      <h1>Contacts CRM</h1>
      <p>Sign in to continue</p>
      <div class="login-row" style="margin-bottom:8px">
        <input type="text" id="loginEmail" placeholder="Email" autocomplete="username" />
        <input type="password" id="loginPassword" placeholder="Password" autocomplete="current-password" />
      </div>
      <div class="login-row">
        <button id="loginBtn" class="btn">Sign in</button>
        <button id="toggleModeLogin" class="btn secondary" title="Light/Dark">üåô / ‚òÄÔ∏è</button>
      </div>
      <p id="loginErr" style="color:var(--danger);margin-top:10px;display:none"></p>
    </div>
  </div>

  <!-- APP (hidden until auth) -->
  <div id="appView" class="app hidden">
    <header>
      <!-- Top row: mode/export/counter + user -->
      <div class="row wrap" style="justify-content:space-between">
        <div class="row">
          <button id="toggleMode" class="btn secondary" title="Toggle light/dark">üåô / ‚òÄÔ∏è</button>
          <button id="exportBtn" class="btn secondary" title="Export filtered CSV">‚¨áÔ∏è Export CSV</button>
          <span id="resultCount" class="counter"></span>
        </div>
        <div class="row">
          <span id="whoami" class="counter"></span>
          <button id="logoutBtn" class="btn secondary">Sign out</button>
        </div>
      </div>

      <!-- Search + Filters toggle row -->
      <div class="header-row">
        <div class="search">
          <span class="icon">üîé</span>
          <input id="q" placeholder="Search name, company, email, phone, tag‚Ä¶" autocomplete="off" />
        </div>
        <button class="btn secondary" id="filtersBtn">Filters</button>
      </div>

      <!-- Filters row -->
      <div class="row wrap" id="filters">
        <select id="f_country"><option value="">All Countries</option></select>
        <select id="f_city"><option value="">All Cities</option></select>
        <select id="f_org"><option value="">All Org types</option></select>
        <select id="f_tag"><option value="">All Tags</option></select>
        <button id="clearFilters" class="btn secondary">Clear</button>
      </div>
    </header>

    <div class="list" id="list"></div>
    <div id="empty" class="empty" style="display:none">No contacts match your search/filters.</div>

    <button id="addBtn" class="btn fab">‚ûï Add</button>

    <!-- Modal -->
    <dialog id="modal">
      <div class="modal-head">
        <strong id="modalTitle">New contact</strong>
        <button class="btn secondary" id="closeModal">‚úï</button>
      </div>
      <form id="form" method="dialog">
        <div class="modal-body">
          <input type="hidden" id="docId" />
          <div class="grid two">
            <div class="col"><label>Full name</label><input type="text" id="FullName" placeholder="e.g., Teo Sze Cheng" required /></div>
            <div class="col"><label>Job title</label><input type="text" id="job_title" placeholder="Director" /></div>
            <div class="col"><label>Department</label><input type="text" id="department" placeholder="International Relations" /></div>
            <div class="col"><label>Company</label><input type="text" id="Company" placeholder="Temasek Polytechnic" /></div>
            <div class="col"><label>Org type</label><input type="text" id="org_type" placeholder="Education" /></div>
            <div class="col"><label>Address</label><input type="text" id="Address" placeholder="21 Tampines Avenue 1‚Ä¶" /></div>
            <div class="col"><label>City</label><input type="text" id="city" placeholder="Singapore" /></div>
            <div class="col"><label>Country</label><input type="text" id="country" placeholder="Singapore" /></div>
            <div class="col"><label>Country code</label><input type="text" id="country_code" placeholder="SG" /></div>
            <div class="col"><label>Office numbers (comma separated)</label><input type="text" id="office_number" placeholder="+6567805331, +6567000000" /></div>
            <div class="col"><label>Mobile numbers (comma separated)</label><input type="text" id="mobile_number" placeholder="+6591234567" /></div>
            <div class="col"><label>Fax numbers (comma separated)</label><input type="text" id="fax_number" placeholder="" /></div>
            <div class="col"><label>Emails (comma separated)</label><input type="text" id="Email" placeholder="name@example.com" /></div>
            <div class="col"><label>Website</label><input type="text" id="Website" placeholder="https://example.com" /></div>
            <div class="col"><label>Inferred seniority</label><input type="text" id="inferred_seniority" placeholder="Senior Management" /></div>
            <div class="col"><label>Name origin</label><input type="text" id="inferred_name_origin" placeholder="Chinese" /></div>
            <div class="col"><label>Region</label><input type="text" id="inferred_region" placeholder="Southeast Asia" /></div>
            <div class="col"><label>Contact tier</label><input type="text" id="inferred_contact_tier" placeholder="Tier 2" /></div>
            <div class="col"><label>Network cluster</label><input type="text" id="network_cluster" placeholder="Singapore Education & Academia" /></div>
            <div class="col" style="grid-column:1/-1"><label>Suggested next action</label><textarea id="suggested_next_action" rows="2" placeholder="Inquire about‚Ä¶"></textarea></div>
            <div class="col"><label>Tag</label><input type="text" id="tag" placeholder="Bernadette" /></div>
            <div class="col"><label>Updated at (auto)</label><input type="text" id="updated_at" disabled /></div>
            <div class="col" style="grid-column:1/-1"><label>Search keywords (auto)</label><input type="text" id="search_keywords" disabled /></div>
          </div>
        </div>
        <div class="modal-foot">
          <button type="button" id="deleteBtn" class="btn danger">üóë Delete</button>
          <div class="row">
            <button type="button" id="duplicateBtn" class="btn secondary">üß¨ Duplicate</button>
            <button type="submit" id="saveBtn" class="btn">üíæ Save</button>
          </div>
        </div>
      </form>
    </dialog>
  </div>

  <script type="module">
    /* ================= Firebase (v11 CDN) ================= */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore, collection, onSnapshot, addDoc, setDoc, doc, deleteDoc,
      serverTimestamp, query, orderBy
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import {
      getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    /* -------------------- Firebase -------------------- */
    const firebaseConfig = {
      apiKey: "AIzaSyB5lFiB9grDsedR9osrB2zvE71l91zHjz0",
      authDomain: "va-solutions-eadd3.firebaseapp.com",
      projectId: "va-solutions-eadd3",
      storageBucket: "va-solutions-eadd3.appspot.com",
      messagingSenderId: "365317326824",
      appId: "1:365317326824:web:d6f4ad9d09c2bf0b20865d",
      measurementId: "G-SF7LBZWS2V"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    /* ================= Utilities & Theme ================= */
    const $ = (id)=>document.getElementById(id);
    const OWNER_EMAIL = "shawn@vizalliance.com.sg";
    function setMode(mode){
      document.body.classList.toggle('dark', mode==='dark');
      document.body.classList.toggle('light', mode==='light');
      localStorage.setItem('crm.mode', mode);
    }
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    setMode(localStorage.getItem('crm.mode') || (prefersDark ? 'dark' : 'light'));
    $('toggleModeLogin').addEventListener('click', ()=>{ setMode(document.body.classList.contains('dark')?'light':'dark'); });
    $('toggleMode').addEventListener('click', ()=>{ setMode(document.body.classList.contains('dark')?'light':'dark'); });

    /* ================= Auth Flow ================= */
    let currentUser = null;
    $('loginBtn').addEventListener('click', async ()=>{
      $('loginErr').style.display='none';
      const email = $('loginEmail').value.trim();
      const pass = $('loginPassword').value;
      try{ await signInWithEmailAndPassword(auth, email, pass); }
      catch(e){ $('loginErr').textContent = e.message || 'Login failed'; $('loginErr').style.display='block'; }
    });
    $('logoutBtn').addEventListener('click', ()=>signOut(auth).catch(console.error));

    onAuthStateChanged(auth,(user)=>{
      currentUser = user || null;
      $('loginView').classList.toggle('hidden', !!user);
      $('appView').classList.toggle('hidden', !user);
      $('whoami').textContent = user ? user.email : '';
      // lock UI for non-owner
      const isOwner = !!user && user.email === OWNER_EMAIL;
      $('addBtn').classList.toggle('hidden', !isOwner);
      lockFormForPermissions();
      if(user){ startListenerOnce(); }
    });

    /* ================= Data ================= */
    const COL = collection(db, 'contacts');
    let contacts = [];
    let started = false;
    let useOrdered = true;
    function startListenerOnce(){
      if(started) return; started = true;
      try{
        const qSnap = useOrdered ? query(COL, orderBy('updated_at','desc')) : COL;
        onSnapshot(qSnap, (snap)=>{
          contacts = snap.docs.map(d => ({ id:d.id, ...normalizeDoc(d.data()) }));
          buildFilterOptions();
          render();
        }, (err)=>{
          console.warn('[CRM] ordered snapshot failed; fallback to unordered', err);
          if(useOrdered){ useOrdered=false; started=false; startListenerOnce(); }
        });
      }catch(e){
        console.warn('[CRM] listener setup failed; fallback unordered', e);
        if(useOrdered){ useOrdered=false; started=false; startListenerOnce(); }
      }
    }

    const arr = v => Array.isArray(v) ? v : (v ? [v] : []);

    function normalizeDoc(x){
      const updatedIso = (x.updated_at && typeof x.updated_at.toDate === 'function') ? x.updated_at.toDate().toISOString() : (x.updated_at || '');
      return {
        FullName: x.FullName || x.fullname || '',
        job_title: x.job_title || '',
        department: x.department || '',
        Company: x.Company || x.company || '',
        org_type: x.org_type || '',
        Address: x.Address || x.address || '',
        city: x.city || '',
        country: x.country || '',
        country_code: x.country_code || '',
        office_number: arr(x.office_number),
        mobile_number: arr(x.mobile_number),
        fax_number: arr(x.fax_number),
        Email: arr(x.Email || x.email),
        Website: x.Website || x.website || '',
        updated_at: updatedIso,
        inferred_seniority: x.inferred_seniority || '',
        inferred_name_origin: x.inferred_name_origin || '',
        inferred_region: x.inferred_region || '',
        inferred_contact_tier: x.inferred_contact_tier || '',
        network_cluster: x.network_cluster || '',
        suggested_next_action: x.suggested_next_action || '',
        tag: x.tag || '',
        search_keywords: (x.search_keywords) ? String(x.search_keywords) : buildSearchKeywords(x),
      };
    }

    function buildSearchKeywords(x){
      const toArr = v => Array.isArray(v) ? v : (v ? [v] : []);
      const parts = [
        x.FullName,x.job_title,x.department,x.Company||x.company,x.org_type,x.Address||x.address,x.city,x.country,x.country_code,
        x.inferred_seniority,x.inferred_name_origin,x.inferred_region,x.inferred_contact_tier,x.network_cluster,x.tag,
        toArr(x.Email).join(' '), toArr(x.office_number).join(' '), toArr(x.mobile_number).join(' '), toArr(x.fax_number).join(' ')
      ].filter(Boolean);
      return parts.join(' ').toLowerCase();
    }

    /* ================= Email / Phone Sanitizers (PATCH) ================= */
    const EMAIL_RX = /[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i;

    function validEmail(s){ return EMAIL_RX.test(String(s||'')); }
    function extractEmails(s){
      const text = String(s||'');
      const matches = text.match(new RegExp(EMAIL_RX, 'gi')) || [];
      return matches;
    }
    function firstEmail(r){
      const fromArray = arr(r.Email).filter(validEmail);
      if(fromArray.length) return fromArray[0];
      // Sometimes "Website" or other fields accidentally hold an email‚Äîuse as fallback.
      const fromWebsite = extractEmails(r.Website);
      if(fromWebsite.length) return fromWebsite[0];
      const fromKeywords = extractEmails(r.search_keywords);
      return fromKeywords[0] || '';
    }

    // Minimal country -> calling code map for normalizing phones
    const CC_MAP = {
      SG:'65','Singapore':'65',
      ID:'62','Indonesia':'62',
      PH:'63','Philippines':'63',
      MY:'60','Malaysia':'60',
      TH:'66','Thailand':'66',
      VN:'84','Vietnam':'84',
      US:'1','United States':'1'
    };

    function digitsOnly(s){ return String(s||'').replace(/\D/g,''); }

    function toE164(raw, country, countryCode){
      let num = String(raw||'').trim();
      if(!num) return '';
      const digits = digitsOnly(num);
      if(!digits) return '';
      const cc = CC_MAP[countryCode] || CC_MAP[country] || '';
      // If already has +, keep digits as is with a plus
      if(num.startsWith('+')) return '+' + digits;
      // Strip leading 00 (international prefix)
      if(digits.startsWith('00')) return '+' + digits.slice(2);
      // If number already starts with country code, add plus
      if(cc && digits.startsWith(cc)) return '+' + digits;
      // If leading 0 national format, replace with country code
      if(cc && digits.startsWith('0')) return '+' + cc + digits.slice(1);
      // If length looks local and we know a country, prefix it
      if(cc && digits.length >= 8 && digits.length <= 11) return '+' + cc + digits;
      // Fallback: best-effort with plus
      return '+' + digits;
    }

    function firstPhone(r){
      const candidates = [...arr(r.mobile_number), ...arr(r.office_number)]
        .map(v=>String(v||'').trim())
        .filter(v => v && digitsOnly(v).length >= 7 && !/^[A-Za-z]{2}$/.test(v)); // filter out stray "ID", etc.
      if(!candidates.length) return '';
      return toE164(candidates[0], r.country, r.country_code);
    }

    function safeWebsite(raw, emailCandidate){
      const val = String(raw||'').trim();
      if(!val) return '';
      // If it's actually an email, don't put under Website (unless we had no email at all).
      if(EMAIL_RX.test(val)) return emailCandidate ? '' : val;
      // Add protocol if looks like a domain
      if(/^[\w.-]+\.[a-z]{2,}/i.test(val) && !/^https?:\/\//i.test(val)) return 'https://' + val;
      return val;
    }

    /* ================= Filters & Search ================= */
    const filters = ['f_country','f_city','f_org','f_tag'];
    $('filtersBtn').addEventListener('click', ()=>{
      const el = $('filters');
      el.style.display = (el.style.display === 'none' || !el.style.display) ? 'flex' : 'none';
    });
    $('clearFilters').addEventListener('click', ()=>{ filters.forEach(id=>$(id).value=''); render(); });
    $('q').addEventListener('input', ()=>render());

    function buildFilterOptions(){
      const uniq = (arr)=>Array.from(new Set(arr.filter(Boolean))).sort((a,b)=>String(a).localeCompare(String(b)));
      fillSelect('f_country', uniq(contacts.map(x=>x.country)));
      fillSelect('f_city', uniq(contacts.map(x=>x.city)));
      fillSelect('f_org', uniq(contacts.map(x=>x.org_type)));
      fillSelect('f_tag', uniq(contacts.map(x=>x.tag)));
    }
    function fillSelect(id, items){
      const el = $(id); const keep = el.value;
      el.innerHTML = '<option value=\"\">All</option>' + items.map(v=>`<option>${escapeHtml(v)}</option>`).join('');
      el.value = keep || '';
      el.onchange = render;
    }

    /* ================= Rendering ================= */
    function escapeHtml(s){ return String(s||'').replace(/[&<>\"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])); }

    function waLink(num){
      const d = digitsOnly(num);
      return d ? `https://wa.me/${d}` : '#';
    }

    let lastRenderedRows = [];

    function render(){
      const q = $('q').value.trim().toLowerCase();
      const fCountry = $('f_country').value;
      const fCity = $('f_city').value;
      const fOrg = $('f_org').value;
      const fTag = $('f_tag').value;

      let rows = contacts.slice();
      // Free text search across prepared keywords
      if(q) rows = rows.filter(r => (r.search_keywords||'').includes(q));
      if(fCountry) rows = rows.filter(r => r.country === fCountry);
      if(fCity) rows = rows.filter(r => r.city === fCity);
      if(fOrg) rows = rows.filter(r => r.org_type === fOrg);
      if(fTag) rows = rows.filter(r => String(r.tag||'') === fTag);

      lastRenderedRows = rows;
      $('resultCount').textContent = `${rows.length} results`;

      const list = $('list'); list.innerHTML = '';
      $('empty').style.display = rows.length ? 'none' : 'block';

      const isOwner = !!currentUser && currentUser.email === OWNER_EMAIL;

      for(const r of rows){
        const email = firstEmail(r);
        const phone = firstPhone(r);
        const website = safeWebsite(r.Website, email);

        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="title">${escapeHtml(r.FullName || '(No name)')}</div>
          <div class="subtitle">${escapeHtml([r.job_title, r.department].filter(Boolean).join(', '))}</div>
          <div class="subtitle">${escapeHtml([r.Company, r.city || r.country || ''].filter(Boolean).join(' ‚Ä¢ '))}</div>

          ${email ? `<div class="inline">Email:
            <a href="mailto:${escapeHtml(email)}">${escapeHtml(email)}</a>
            <button class="copy" title="Copy email" data-copy="${escapeHtml(email)}">üìã</button>
          </div>` : ''}

          ${phone ? `<div class="inline">Phone:
            <a href="${waLink(phone)}" target="_blank" rel="noopener">${escapeHtml(phone)}</a>
            <button class="copy" title="Copy number" data-copy="${escapeHtml(phone)}">üìã</button>
          </div>` : ''}

          ${website ? `<div class="inline">Website:
            <a href="${escapeHtml(website)}" target="_blank" rel="noopener">${escapeHtml(website)}</a>
          </div>` : ''}
        `;

        card.querySelectorAll('.copy').forEach(btn=>{
          btn.addEventListener('click', async ()=> {
            try{ await navigator.clipboard.writeText(btn.getAttribute('data-copy')||''); btn.textContent='‚úÖ'; setTimeout(()=>btn.textContent='üìã',1200);}catch(e){ alert('Copy failed'); }
          });
        });

        if(isOwner){
          const actions = document.createElement('div');
          actions.className = 'actions';
          const editBtn = document.createElement('button');
          editBtn.className = 'btn secondary';
          editBtn.textContent = '‚úèÔ∏è Edit';
          editBtn.addEventListener('click', ()=>openModal(r.id));
          actions.appendChild(editBtn);
          card.appendChild(actions);
        }
        list.appendChild(card);
      }
    }

    /* ================= Export CSV (PATCHED) ================= */
    function csvEscape(v){
      const s = String(v ?? '');
      return /[",\n]/.test(s) ? '"' + s.replace(/"/g,'""') + '"' : s;
    }

    $('exportBtn').addEventListener('click', ()=>{
      // Exact header order expected by your sample CSV
      const cols = ['FullName','Email','Phone','Company','city','country','org_type','tag','Website'];
      const lines = [cols.join(',')];

      for(const r of lastRenderedRows){
        const email = firstEmail(r);
        const phone = firstPhone(r);
        const website = safeWebsite(r.Website, email);

        const vals = [
          r.FullName||'',
          email,
          phone,
          r.Company||'',
          r.city||'',
          r.country||'',
          r.org_type||'',
          r.tag||'',
          website||'',
        ].map(csvEscape);

        lines.push(vals.join(','));
      }

      // UTF-8 BOM for Excel compatibility, CRLF line endings
      const csv = '\uFEFF' + lines.join('\r\n');
      const blob = new Blob([csv], { type:'text/csv;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const ts = new Date().toISOString().replace(/[:T]/g,'-').slice(0,19);
      a.href = url; a.download = `contacts_export_${ts}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    });

    /* ================= Modal + CRUD with RBAC ================= */
    const modal = $('modal');
    const form = $('form');
    $('addBtn').addEventListener('click', ()=>openModal());
    $('closeModal').addEventListener('click', ()=>modal.close());

    function openModal(id){
      form.reset();
      $('docId').value = id || '';
      $('modalTitle').textContent = id ? 'Edit contact' : 'New contact';
      $('updated_at').value = new Date().toISOString();

      if(id){
        const r = contacts.find(x=>x.id===id);
        if(r) fillForm(r);
      }
      lockFormForPermissions();
      modal.showModal();
    }

    function fillForm(r){
      $('docId').value = r.id;
      const map = ['FullName','job_title','department','Company','org_type','Address','city','country','country_code',
        'Website','inferred_seniority','inferred_name_origin','inferred_region','inferred_contact_tier','network_cluster',
        'suggested_next_action','tag','search_keywords'];
      map.forEach(k=>{ const el = $(k); if(el) el.value = r[k] || ''; });
      $('office_number').value = (r.office_number||[]).join(', ');
      $('mobile_number').value = (r.mobile_number||[]).join(', ');
      $('fax_number').value = (r.fax_number||[]).join(', ');
      $('Email').value = (r.Email||[]).join(', ');
      $('updated_at').value = r.updated_at || '';
    }

    function lockFormForPermissions(){
      const isOwner = !!currentUser && currentUser.email === OWNER_EMAIL;
      const inputs = form.querySelectorAll('input, textarea, select');
      inputs.forEach(el=>{
        if(el.id==='updated_at' || el.id==='search_keywords'){ el.disabled = true; return; }
        el.disabled = !isOwner;
      });
      ['saveBtn','deleteBtn','duplicateBtn','addBtn'].forEach(id=>{
        const el=$(id); if(el) el.classList.toggle('hidden', !isOwner);
      });
    }

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const isOwner = !!currentUser && currentUser.email === OWNER_EMAIL;
      if(!isOwner){ alert('Read-only user'); return; }
      const data = formToData();
      const id = $('docId').value;
      if(id){
        await setDoc(doc(db,'contacts',id), {
          ...data, updated_at: serverTimestamp(), search_keywords: buildSearchKeywords(data)
        }, { merge:true });
      }else{
        await addDoc(collection(db,'contacts'), {
          ...data, created_at: serverTimestamp(), updated_at: serverTimestamp(), search_keywords: buildSearchKeywords(data)
        });
      }
      modal.close();
    });

    $('deleteBtn').addEventListener('click', async ()=>{
      const isOwner = !!currentUser && currentUser.email === OWNER_EMAIL;
      if(!isOwner){ alert('Read-only user'); return; }
      const id = $('docId').value; if(!id) return;
      if(confirm('Delete this contact? This cannot be undone.')){
        await deleteDoc(doc(db,'contacts',id));
        modal.close();
      }
    });

    $('duplicateBtn').addEventListener('click', async ()=>{
      const isOwner = !!currentUser && currentUser.email === OWNER_EMAIL;
      if(!isOwner){ alert('Read-only user'); return; }
      const data = formToData();
      delete data.updated_at;
      await addDoc(collection(db,'contacts'), {
        ...data, created_at: serverTimestamp(), updated_at: serverTimestamp(), search_keywords: buildSearchKeywords(data)
      });
      alert('Duplicated.');
    });

    function formToData(){
      const get = id => ($(id).value || '').trim();
      const splitCsv = id => get(id).length ? get(id).split(',').map(s=>s.trim()).filter(Boolean) : [];
      return {
        FullName: get('FullName'),
        job_title: get('job_title'),
        department: get('department'),
        Company: get('Company'),
        org_type: get('org_type'),
        Address: get('Address'),
        city: get('city'),
        country: get('country'),
        country_code: get('country_code'),
        office_number: splitCsv('office_number'),
        mobile_number: splitCsv('mobile_number'),
        fax_number: splitCsv('fax_number'),
        Email: splitCsv('Email'),
        Website: get('Website'),
        inferred_seniority: get('inferred_seniority'),
        inferred_name_origin: get('inferred_name_origin'),
        inferred_region: get('inferred_region'),
        inferred_contact_tier: get('inferred_contact_tier'),
        network_cluster: get('network_cluster'),
        suggested_next_action: get('suggested_next_action'),
        tag: get('tag'),
      };
    }
  </script>
</body>
</html>
