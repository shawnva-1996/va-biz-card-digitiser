<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Contacts CRM</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
  :root{
    --brand:#1976d2; --brand-dark:#135ba1;
    --bg:#f5f6fa; --card:#fff;
    --text:#111; --muted:#667085;
    --danger:#ff4d4f; --secondary:#e9edf5;
    --ring:#d0e3ff;
  }
  *{ box-sizing:border-box; }
  body{ margin:0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background:var(--bg); color:var(--text); }
  header{ position:sticky; top:0; background:var(--brand); color:#fff; padding:18px 16px; font-size:1.25rem; font-weight:700; text-align:center; z-index:100; }
  .container{ padding:16px; max-width:900px; margin:0 auto; }
  .hidden{ display:none !important; }

  /* Inputs + Buttons (big, finger friendly) */
  input, select, textarea, button{
    width:100%; padding:16px; border-radius:14px; border:1px solid #e5e7eb; font-size:17px; line-height:1.2;
  }
  input:focus, select:focus, textarea:focus{
    outline:none; box-shadow:0 0 0 4px var(--ring);
  }
  button{ background:var(--brand); color:#fff; border:none; font-weight:700; cursor:pointer; min-height:56px; }
  button:active{ transform:scale(.98); }
  button.secondary{ background:var(--secondary); color:#0b2a4a; }
  button.warn{ background:var(--danger); color:#fff; }

  /* Layout blocks */
  .toolbar{ display:flex; flex-wrap:wrap; gap:12px; margin-bottom:12px; }
  .card{ background:var(--card); border-radius:16px; padding:20px; margin:14px 0; box-shadow:0 2px 10px rgba(0,0,0,.06); }
  .card h3{ margin:0; font-size:1.25rem; }
  .sub{ color:var(--muted); font-size:1rem; margin:6px 0; line-height:1.45; }
  .chips{ display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
  .pill{ display:inline-flex; align-items:center; gap:8px; padding:12px 14px; border-radius:999px; background:#eef4ff; font-size:.95rem; min-height:44px; }
  .pill a{ text-decoration:none; color:inherit; }
  .actions{ display:flex; gap:12px; margin-top:16px; }
  .actions button{ flex:1; }
  .notes{ margin-top:14px; font-size:1rem; color:var(--muted); line-height:1.45; }
  a.link{ color:var(--brand); text-decoration:none; font-weight:700; word-break:break-word; }

  /* Floating Add (only for non-restricted users) */
  .fab{ position:fixed; right:16px; bottom:20px; background:var(--brand); color:#fff; border-radius:999px; width:64px; height:64px; display:flex; align-items:center; justify-content:center; font-size:28px; box-shadow:0 10px 20px rgba(25,118,210,.35); border:none; cursor:pointer; }
  .fab:active{ transform:scale(.98); }

  /* Email chooser modal */
  .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:flex; align-items:flex-end; justify-content:center; padding:16px; }
  .sheet{ background:#fff; width:100%; max-width:560px; border-radius:16px 16px 0 0; padding:12px; }
  .sheet h4{ margin:8px 12px 4px; }
  .provider{ display:flex; align-items:center; gap:12px; padding:14px; border-radius:12px; border:1px solid #e5e7eb; margin:8px 0; font-size:17px; }
  .provider:active{ background:#f3f6ff; }
  .provider span{ font-weight:600; }

  /* Editor grid (mobile-first) */
  .grid{ display:grid; gap:12px; }
  @media (min-width:720px){
    .grid.cols-2{ grid-template-columns:1fr 1fr; }
  }

  /* Helper spacing */
  .mt-8{ margin-top:8px; } .mt-12{ margin-top:12px; } .mt-16{ margin-top:16px; }
</style>
</head>
<body>

<header>Contacts CRM</header>
<div class="container">

  <!-- LOGIN -->
  <div id="loginView" class="card">
    <h2 style="margin:0 0 8px 0;">Login</h2>
    <input id="loginEmail" type="email" placeholder="Email" />
    <input id="loginPassword" class="mt-12" type="password" placeholder="Password" />
    <div class="toolbar mt-12">
      <button onclick="login()">Log in</button>
      <button class="secondary" onclick="signup()">Create Account</button>
    </div>
  </div>

  <!-- CONTACTS LIST -->
  <div id="contactsView" class="hidden">
    <div class="card">
      <div class="toolbar">
        <input id="searchInput" placeholder="Search name / company / email…" oninput="resetAndLoad()" />
        <select id="filterCountry" onchange="resetAndLoad()"><option value="">All countries</option></select>
        <select id="filterCompany" onchange="resetAndLoad()"><option value="">All companies</option></select>
        <button id="logoutBtn" class="secondary" onclick="logout()">Logout</button>
      </div>
    </div>

    <div id="results"></div>
    <button id="loadMoreBtn" class="hidden">Load More</button>

    <!-- Floating Add (visible only when allowed) -->
    <button id="fabAdd" class="fab hidden" title="Add Contact" onclick="showEditor()">＋</button>
  </div>

  <!-- EDITOR (Add / Edit) -->
  <div id="editorView" class="card hidden">
    <h2 id="editorTitle" style="margin:0 0 8px 0;">Add Contact</h2>
    <div class="grid cols-2">
      <input id="f_FullName" placeholder="Full Name" />
      <input id="f_job_title" placeholder="Job Title" />
      <input id="f_department" placeholder="Department" />
      <input id="f_company" placeholder="Company" />
      <input id="f_org_type" placeholder="Org Type e.g., University, Hotel" />
      <input id="f_address" placeholder="Address" />
      <input id="f_city" placeholder="City" />
      <input id="f_country" placeholder="Country" />
      <input id="f_country_code" placeholder="Country Code (SG, PH, …)" />
      <input id="f_office_number" placeholder="Office Numbers (comma/semicolon separated)" />
      <input id="f_mobile_number" placeholder="Mobile Numbers (comma/semicolon separated)" />
      <input id="f_fax_number" placeholder="Fax Numbers (comma/semicolon separated)" />
      <input id="f_email" placeholder="Emails (comma/semicolon separated)" />
      <input id="f_website" placeholder="Website (with or without http)" />
      <textarea id="f_notes" placeholder="Notes" style="grid-column:1 / -1; min-height:110px;"></textarea>
      <input id="f_qrtext" placeholder="QR Text (optional)" style="grid-column:1 / -1;" />
    </div>
    <div class="toolbar mt-16">
      <button id="btnSave" onclick="saveCurrent()">Save</button>
      <button class="secondary" onclick="showContacts()">Cancel</button>
    </div>
  </div>

</div>

<!-- Email provider chooser sheet -->
<div id="emailSheet" class="modal-backdrop hidden" onclick="closeEmailSheet(event)">
  <div class="sheet" onclick="event.stopPropagation()">
    <h4>Send email with</h4>
    <div id="emailChoices"></div>
    <div class="toolbar">
      <button class="secondary" onclick="hideEmailSheet()">Close</button>
    </div>
  </div>
</div>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
/* -------------------- Firebase -------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyB5lFiB9grDsedR9osrB2zvE71l91zHjz0",
  authDomain: "va-solutions-eadd3.firebaseapp.com",
  projectId: "va-solutions-eadd3",
  storageBucket: "va-solutions-eadd3.appspot.com",
  messagingSenderId: "365317326824",
  appId: "1:365317326824:web:d6f4ad9d09c2bf0b20865d",
  measurementId: "G-SF7LBZWS2V"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* -------------------- Role Restriction -------------------- */
const RESTRICTED_USER = "bernadette@meiwei.com";   // view-only + only tag:"Bernadette"

/* -------------------- State -------------------- */
let currentUser = null;
let lastDoc = null;
const PAGE_SIZE = 25;

/* -------------------- Auth Flow -------------------- */
auth.onAuthStateChanged(u=>{
  currentUser = u;
  if(u){ document.getElementById('loginView').classList.add('hidden'); showContacts(); }
  else { document.getElementById('loginView').classList.remove('hidden'); hideAll(['contactsView','editorView']); }
});
function login(){ auth.signInWithEmailAndPassword(loginEmail.value, loginPassword.value).catch(e=>alert(e.message)); }
function signup(){ auth.createUserWithEmailAndPassword(loginEmail.value, loginPassword.value).catch(e=>alert(e.message)); }
function logout(){ auth.signOut(); }

function isRestricted(){ return currentUser && currentUser.email === RESTRICTED_USER; }

/* -------------------- Views -------------------- */
function hideAll(ids){ ids.forEach(id=>document.getElementById(id).classList.add('hidden')); }
function showContacts(){
  hideAll(['editorView']);
  document.getElementById('contactsView').classList.remove('hidden');
  // Show FAB only for non-restricted
  document.getElementById('fabAdd').classList.toggle('hidden', isRestricted());
  resetAndLoad();
}
function showEditor(docId){
  if(isRestricted()){ alert("You do not have permission to create or edit contacts."); return; }
  hideAll(['contactsView']);
  document.getElementById('editorView').classList.remove('hidden');
  document.getElementById('editorTitle').innerText = docId ? "Edit Contact" : "Add Contact";
  clearEditor();
  if(docId){ loadIntoEditor(docId); }
}

/* -------------------- Filters + Search -------------------- */
async function resetAndLoad(){
  lastDoc = null;
  results.innerHTML = "";
  await loadFilters();
  await loadMore();
}
async function loadFilters(){
  // Build filters from a small sample (respect restriction)
  let q = db.collection('contacts').orderBy('FullName').limit(200);
  if(isRestricted()){
    // Prefer server-side filtering; might require composite index with orderBy('FullName')
    q = db.collection('contacts').where('tag','==','Bernadette').orderBy('FullName').limit(200);
  }
  const snap = await q.get().catch(async (err)=>{
    // Fallback if index is missing: fetch without where and filter client-side
    const s2 = await db.collection('contacts').orderBy('FullName').limit(200).get();
    return { docs: s2.docs.filter(d => (d.data().tag||"") === "Bernadette") };
  });

  const countries = new Set(), companies = new Set();
  snap.docs.forEach(doc=>{
    const d = doc.data();
    if(d.country) countries.add(d.country);
    if(d.company) companies.add(d.company);
  });
  const cSel = document.getElementById('filterCountry');
  const coSel = document.getElementById('filterCompany');
  const cVal = cSel.value, coVal = coSel.value;
  cSel.innerHTML = `<option value="">All countries</option>` + [...countries].sort().map(c=>`<option>${escapeHtml(c)}</option>`).join('');
  coSel.innerHTML = `<option value="">All companies</option>` + [...companies].sort().map(c=>`<option>${escapeHtml(c)}</option>`).join('');
  if(cVal) cSel.value = cVal;
  if(coVal) coSel.value = coVal;
}

/* -------------------- Pagination Load -------------------- */
async function loadMore(){
  const search = searchInput.value.toLowerCase().trim();
  const fCountry = filterCountry.value;
  const fCompany = filterCompany.value;

  let q = db.collection('contacts').orderBy('FullName').limit(PAGE_SIZE);

  if(isRestricted()){
    // Try server-side: only Bernadette-tagged
    q = db.collection('contacts').where('tag','==','Bernadette').orderBy('FullName').limit(PAGE_SIZE);
  }

  if(lastDoc){ q = q.startAfter(lastDoc); }

  let snap;
  try{
    snap = await q.get();
  }catch(err){
    // No composite index? Fallback to client-side filter for restriction + order
    const s2 = await db.collection('contacts').orderBy('FullName').limit(PAGE_SIZE).get();
    s2.docs.forEach(d=>{ d._keep = (d.data().tag||"") === "Bernadette"; });
    snap = { docs: s2.docs.filter(d => d._keep), size: s2.size, empty: s2.size===0 };
  }

  const rows = [];
  snap.docs.forEach(doc=>{
    const d = { id: doc.id, ...doc.data() };
    if(isRestricted() && (d.tag||"") !== "Bernadette") return; // double-check
    if(search && !((d.search_keywords||"").toLowerCase().includes(search))) return;
    if(fCountry && (d.country||"") !== fCountry) return;
    if(fCompany && (d.company||"") !== fCompany) return;
    rows.push(d);
  });

  if(snap.docs && snap.docs.length>0) lastDoc = snap.docs[snap.docs.length-1];

  rows.forEach(renderCard);
  loadMoreBtn.classList.toggle('hidden', snap.empty || (snap.size && snap.size < PAGE_SIZE));
}

/* -------------------- Rendering -------------------- */
function renderCard(d){
  const el = document.createElement('div');
  el.className = 'card';

  const emails = (d.email||[]).map(e=>emailPill(e)).join('');
  const mobiles = (d.mobile_number||[]).map(m=>phonePill(m)).join('');
  const offices = (d.office_number||[]).map(m=>phonePill(m, true)).join('');
  const website = d.website ? `<div class="notes">🌐 <a class="link" href="${ensureHttp(d.website)}" target="_blank" rel="noopener">${escapeHtml(d.website)}</a></div>` : '';

  const canEdit = currentUser && !isRestricted();

  el.innerHTML = `
    <h3>${escapeHtml(d.FullName||'(No name)')}</h3>
    <div class="sub">${escapeHtml(d.job_title||'')}${d.company?(' · '+escapeHtml(d.company)) : ''}</div>
    <div class="sub">${escapeHtml(d.department||'')}${d.org_type?(' · '+escapeHtml(d.org_type)) : ''}</div>
    <div class="sub">${escapeHtml(d.address||'')}${d.city?(', '+escapeHtml(d.city)) : ''}${d.country?(', '+escapeHtml(d.country)) : ''}</div>

    <div class="chips">
      ${emails}
      ${mobiles}
      ${offices}
      ${d.tag? `<div class="pill">🏷 ${escapeHtml(d.tag)}</div>`:''}
    </div>

    ${website}

    ${canEdit ? `
      <div class="actions">
        <button onclick="showEditor('${d.id}')">Edit</button>
        <button class="warn" onclick="deleteContact('${d.id}')">Delete</button>
      </div>
    `: ''}

    <div class="notes">Notes: ${escapeHtml(d.notes||'—')}</div>
  `;
  results.appendChild(el);
}

function emailPill(email){
  const safe = escapeHtml(email);
  return `
    <div class="pill" role="button" tabindex="0" onclick="openEmailChooser('${encodeURIComponent(email)}')">
      📧 <span>${safe}</span>
    </div>`;
}
function phonePill(phone, isOffice=false){
  const label = isOffice ? '☎️' : '📱';
  const normalized = toWhatsAppNumber(phone);
  const safe = escapeHtml(phone);
  return `
    <div class="pill">
      ${label} <a href="https://wa.me/${normalized}" target="_blank" rel="noopener">${safe}</a>
    </div>`;
}

/* -------------------- Email Chooser -------------------- */
function openEmailChooser(encodedEmail){
  const email = decodeURIComponent(encodedEmail);
  const choices = [
    { name:'Default Mail App', href:`mailto:${encodeURIComponent(email)}` },
    { name:'Gmail', href:`https://mail.google.com/mail/?view=cm&to=${encodeURIComponent(email)}` },
    { name:'Outlook (Office 365)', href:`https://outlook.office.com/mail/deeplink/compose?to=${encodeURIComponent(email)}` },
    { name:'Yahoo Mail', href:`https://compose.mail.yahoo.com/?to=${encodeURIComponent(email)}` },
  ];
  const box = document.getElementById('emailChoices');
  box.innerHTML = choices.map(c => `
    <a class="provider" href="${c.href}" target="_blank" rel="noopener">
      ✉️ <span>${c.name}</span>
    </a>
  `).join('');
  document.getElementById('emailSheet').classList.remove('hidden');
}
function hideEmailSheet(){ document.getElementById('emailSheet').classList.add('hidden'); }
function closeEmailSheet(e){ if(e.target.id==='emailSheet'){ hideEmailSheet(); } }

/* -------------------- Create / Edit / Delete -------------------- */
let editingId = null;

function clearEditor(){
  editingId = null;
  const ids = ['f_FullName','f_job_title','f_department','f_company','f_org_type','f_address','f_city','f_country','f_country_code','f_office_number','f_mobile_number','f_fax_number','f_email','f_website','f_notes','f_qrtext'];
  ids.forEach(id=>document.getElementById(id).value='');
}

async function loadIntoEditor(id){
  const doc = await db.collection('contacts').doc(id).get();
  const d = doc.data(); editingId = id;
  f_FullName.value = d.FullName||''; f_job_title.value=d.job_title||''; f_department.value=d.department||'';
  f_company.value=d.company||''; f_org_type.value=d.org_type||''; f_address.value=d.address||'';
  f_city.value=d.city||''; f_country.value=d.country||''; f_country_code.value=d.country_code||'';
  f_office_number.value=(d.office_number||[]).join(', '); f_mobile_number.value=(d.mobile_number||[]).join(', ');
  f_fax_number.value=(d.fax_number||[]).join(', '); f_email.value=(d.email||[]).join(', ');
  f_website.value=d.website||''; f_notes.value=d.notes||''; f_qrtext.value=d.QR_text||'';
}

function splitList(v){ return v ? v.split(/[;,]/).map(s=>s.trim()).filter(Boolean) : []; }
function buildSearchKeywords(obj){
  const fields = [
    obj.FullName, obj.job_title, obj.department, obj.company, (obj.email||[]).join(" "),
    obj.address, obj.city, obj.country, obj.org_type
  ].map(x=>x||'');
  return fields.join(' ').toLowerCase();
}

async function saveCurrent(){
  if(isRestricted()){ alert("You do not have permission to create or edit contacts."); return; }
  const data = {
    FullName: f_FullName.value.trim(),
    job_title: f_job_title.value.trim(),
    department: f_department.value.trim(),
    company: f_company.value.trim(),
    org_type: f_org_type.value.trim(),
    address: f_address.value.trim(),
    city: f_city.value.trim(),
    country: f_country.value.trim(),
    country_code: f_country_code.value.trim(),
    office_number: splitList(f_office_number.value),
    mobile_number: splitList(f_mobile_number.value),
    fax_number: splitList(f_fax_number.value),
    email: splitList(f_email.value),
    website: f_website.value.trim(),
    notes: f_notes.value.trim(),
    QR_text: f_qrtext.value.trim(),
    tag: "Bernadette", // keeping your requested tag default
    updated_at: new Date().toISOString(),
    updated_by: currentUser?.email || "",
  };
  data.search_keywords = buildSearchKeywords(data);

  if(editingId){
    await db.collection('contacts').doc(editingId).set(data, { merge:true });
    alert('Updated.');
  }else{
    data.created_at = firebase.firestore.FieldValue.serverTimestamp();
    data.created_by = currentUser?.email || "";
    await db.collection('contacts').add(data);
    alert('Created.');
  }
  showContacts();
}

async function deleteContact(id){
  if(isRestricted()){ alert("You do not have permission to delete contacts."); return; }
  if(confirm('Delete this contact?')){
    await db.collection('contacts').doc(id).delete();
    resetAndLoad();
  }
}

/* -------------------- Utilities -------------------- */
function ensureHttp(url){
  const u = (url||'').trim();
  if(!u) return '';
  return /^https?:\/\//i.test(u) ? u : ('http://' + u);
}
function toWhatsAppNumber(n){
  if(!n) return '';
  // strip non-digits; if starts with 00, convert to intl; if starts with 0 we cannot infer country, assume number already includes country code in your data
  let digits = (n+'').replace(/\D/g,'');
  // If original had leading +, digits is already fine (e.g., +65 9123 -> 659123)
  return digits;
}
function escapeHtml(s){ return (s??"").toString().replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
</script>
</body>
</html>
